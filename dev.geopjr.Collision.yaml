app-id: dev.geopjr.Collision
runtime: org.gnome.Platform
runtime-version: '45'
sdk: org.gnome.Sdk
command: collision
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.a'
  - '*.la'

modules:
  # Required by Crystal
  - name: livevent
    sources:
      - type: git
        url: https://github.com/libevent/libevent.git
        tag: release-2.1.12-stable
  # Required by Crystal's yaml
  # which is being used by the binding generator
  - name: libyaml
    sources:
      - type: archive
        url: https://github.com/yaml/libyaml/releases/download/0.2.5/yaml-0.2.5.tar.gz
        sha256: c642ae9b75fee120b2d96c712538bd2cf283228d2337df2cf2988e3c02678ef4
  # Collision
  - name: collision
    buildsystem: simple
    build-options:
      append-path: /run/build/collision/crystal/bin/
      env:
        CC: "gcc"
        BLAKE3_NO_SSE2: "1"
        BLAKE3_NO_SSE41: "1"
        BLAKE3_NO_AVX2: "1"
        BLAKE3_NO_AVX512: "1"
        BLAKE3_USE_NEON: "1"
    build-commands:
      - "sed -i 's/{{ `shards version #{__DIR__}`.strip.stringify }}/{{read_file(\"\
        #{__DIR__}\\/..\\/..\\/shard.yml\").split(\"version: \")[1].split(\"\\\\n\"\
        )[0]}}/' ./lib/gi-crystal/src/generator/main.cr"
      - for i in ./lib/*/; do ln -snf ".." "$i/lib"; done
      - cd lib/blake3/blake3c && make -f ../build/Makefile && cd ../../..
      - cd lib/gi-crystal && crystal build src/generator/main.cr && cd ../.. && mkdir
        ./bin && cp lib/gi-crystal/main ./bin/gi-crystal
      - ./bin/gi-crystal
      - COLLISION_LOCALE_LOCATION="/app/share/locale" crystal/bin/crystal build ./src/collision.cr
        -Dpreview_mt --no-debug --release
      - msgfmt --xml --template data/dev.geopjr.Collision.metainfo.xml.in -d "./po"
        -o data/dev.geopjr.Collision.metainfo.xml
      - msgfmt --desktop --template data/dev.geopjr.Collision.desktop.in -d "./po"
        -o data/dev.geopjr.Collision.desktop
      - mkdir -p po/mo && for lang in `cat "po/LINGUAS"`; do if [[ "$lang" == 'en'
        || "$lang" == '' ]]; then continue; fi; mkdir -p "/app/share/locale/$lang/LC_MESSAGES";
        msgfmt "po/$lang.po" -o "po/mo/$lang.mo";  install -D -m 0644 "po/mo/$lang.mo"
        "/app/share/locale/$lang/LC_MESSAGES/dev.geopjr.Collision.mo"; done
    post-install:
      - install -D -m 0755 collision /app/bin/collision
      - install -D -m 0644 data/dev.geopjr.Collision.desktop /app/share/applications/dev.geopjr.Collision.desktop
      - install -D -m 0644 data/icons/dev.geopjr.Collision.svg /app/share/icons/hicolor/scalable/apps/dev.geopjr.Collision.svg
      - install -D -m 0644 data/icons/dev.geopjr.Collision-symbolic.svg /app/share/icons/hicolor/symbolic/apps/dev.geopjr.Collision-symbolic.svg
      - install -D -m 0644 data/dev.geopjr.Collision.metainfo.xml /app/share/metainfo/dev.geopjr.Collision.metainfo.xml
      - install -D -m 0644 data/dev.geopjr.Collision.gschema.xml /app/share/glib-2.0/schemas/dev.geopjr.Collision.gschema.xml
      - glib-compile-schemas /app/share/glib-2.0/schemas
    sources:
      - type: git
        url: https://github.com/GeopJr/Collision.git
        tag: v3.7.0
        commit: 96ed26477856ed50301cea3ea6fa59fe59cb3484
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: archive
        dest: crystal/
        url: https://github.com/crystal-lang/crystal/releases/download/1.10.1/crystal-1.10.1-1-linux-x86_64.tar.gz
        sha256: 1742e3755d3653d1ba07c0291f10a517fa392af87130dba4497ed9d82c12348b
        only_arches:
          - x86_64
      - type: archive
        dest: crystal/
        url: https://github.com/geopjr-forks/crystal-aarch64/releases/download/v1.9.2/crystal-1.9.2-1-linux-aarch64.tar.xz
        sha256: b27042a5b421174dfe14ab4295b3ac90ebc0b915ce8e04b4c435228c31a4624a
        only_arches:
          - aarch64
      - type: git
        url: https://github.com/geopjr/blake3.cr.git
        tag: v1.2.0
        dest: lib/blake3
      - type: git
        url: https://github.com/geopjr/gettext.cr.git
        tag: v1.0.0
        dest: lib/gettext
      - type: git
        url: https://github.com/hugopl/gi-crystal.git
        tag: v0.21.0
        dest: lib/gi-crystal
      - type: git
        url: https://github.com/hugopl/gtk4.cr.git
        tag: v0.16.0
        dest: lib/gtk4
      - type: git
        url: https://github.com/hugopl/harfbuzz.cr.git
        tag: v0.2.0
        dest: lib/harfbuzz
      - type: git
        url: https://github.com/geopjr/libadwaita.cr.git
        commit: cffabb56e911d2a90c53c2fd14d6bd08bf5ac446
        dest: lib/libadwaita
      - type: git
        url: https://github.com/geopjr/non-blocking-spawn.git
        tag: v1.0.5
        dest: lib/non-blocking-spawn
      - type: git
        url: https://github.com/hugopl/pango.cr.git
        tag: v0.3.1
        dest: lib/pango
